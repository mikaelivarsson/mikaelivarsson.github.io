<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Slip Reducer - ivarsson.one</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 2rem; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; }
        .outcome-cell { display: flex; gap: 8px; }
        .outcome-cell span { display: inline-block; width: 25px; text-align: center; font-weight: bold; border: 1px solid #d1d5db; border-radius: 4px; }
        .outcome-cell span.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .green { color: green; font-weight: bold; }
        .red { color: red; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto">
        <main class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div class="md:col-span-3 card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Draw Information</h2>
                <div class="mb-4">
                    <label for="gameSelect" class="block text-gray-700 font-medium mb-1">Select Game:</label>
                    <select id="gameSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="stryktipset">Stryktipset</option>
                        <option value="europatipset">Europatipset</option>
                    </select>
                </div>
                <div id="drawInfo" class="mb-4">
                    <p id="productName" class="text-blue-600 font-bold">Product: N/A</p>
                    <p id="closeTime" class="text-gray-600">Close Time: N/A</p>
                </div>
                <button id="fetchBtn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Fetch Data</button>
                
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Slip Filters</h3>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">Favorites</label>
                        <div class="flex gap-2">
                            <input type="number" id="minFavs" value="6" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="maxFavs" value="7" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">Underdogs</label>
                        <div class="flex gap-2">
                            <input type="number" id="minUnderdogs" value="3" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="maxUnderdogs" value="4" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">Draws (X)</label>
                        <div class="flex gap-2">
                            <input type="number" id="minDraws" value="3" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="maxDraws" value="4" class="w-1/2 p-2 border border-gray-300 rounded-lg text-center">
                        </div>
                    </div>
                    <button id="calculateBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Calculate Slips</button>
                    <div id="results" class="mt-4 text-center">
                        <p class="text-sm">Filtered: <span id="filteredSlips" class="font-bold text-green-600">0</span> / <span id="totalSlips">0</span></p>
                    </div>
                    <div class="mt-4 flex flex-col gap-2">
                        <button id="exportSlipsBtn" class="w-full bg-gray-500 text-white py-2 rounded-lg disabled:opacity-50" disabled>Export Slips</button>
                        <button id="exportAnalysisBtn" class="w-full bg-gray-500 text-white py-2 rounded-lg disabled:opacity-50" disabled>Export Analysis</button>
                    </div>
                </div>
            </div>

            <div class="md:col-span-9 card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Match Selections</h2>
                    <button id="toggleAllBtn" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Toggle All</button>
                </div>
                <div id="matchesTable" class="table-container"></div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameSelect = document.getElementById('gameSelect');
            const fetchBtn = document.getElementById('fetchBtn');
            const productNameSpan = document.getElementById('productName');
            const closeTimeSpan = document.getElementById('closeTime');
            const matchesTable = document.getElementById('matchesTable');

            let allMatches = [];
            let currentFilteredSlips = [];
            
            const day = new Date().getDay();
            if (day === 3 || day === 4) gameSelect.value = "europatipset";

            async function fetchData(url) {
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                try {
                    const response = await fetch(proxyUrl);
                    return await response.json();
                } catch (e) { return null; }
            }

            function parseMatches(data) {
                if (!data || !data.draws) return { matches: [], name: "N/A", time: "N/A" };
                const openDraws = data.draws.filter(d => d.drawState === 'Open');
                const draw = openDraws.sort((a, b) => new Date(a.closeTime) - new Date(b.closeTime))[0] || data.draws[0];
                
                const matches = draw.events.map(e => {
                    const o = { '1': parseFloat(e.odds.home.replace(',','.')), 'X': parseFloat(e.odds.draw.replace(',','.')), '2': parseFloat(e.odds.away.replace(',','.')) };
                    const sorted = Object.entries(o).sort((a,b) => a[1]-b[1]);
                    return {
                        home: e.participants.find(p => p.type === 'home').name,
                        away: e.participants.find(p => p.type === 'away').name,
                        odds: o,
                        dist: { '1': e.distribution.home, 'X': e.distribution.draw, '2': e.distribution.away },
                        fav: sorted[0][0],
                        und: sorted[2][0]
                    };
                });
                return { matches, name: draw.productName, time: new Date(draw.closeTime).toLocaleString('sv-SE') };
            }

            function render(matches) {
                let html = `<table><thead><tr><th>ID</th><th>Match</th><th>Odds</th><th>Dist %</th><th>Play</th><th>Select</th><th>ID</th></tr></thead><tbody>`;
                matches.forEach((m, i) => {
                    const p1 = (100/m.odds['1']/m.dist['1']).toFixed(1), pX = (100/m.odds['X']/m.dist['X']).toFixed(1), p2 = (100/m.odds['2']/m.dist['2']).toFixed(1);
                    html += `<tr>
                        <td>${i+1}</td>
                        <td class="text-sm font-medium">${m.home} - ${m.away}</td>
                        <td class="text-xs text-gray-500">${m.odds['1']}, ${m.odds['X']}, ${m.odds['2']}</td>
                        <td class="text-xs">${m.dist['1']}, ${m.dist['X']}, ${m.dist['2']}</td>
                        <td><span class="${p1>1.3?'green':p1<0.8?'red':''}">${p1}</span>, <span class="${pX>1.3?'green':pX<0.8?'red':''}">${pX}</span>, <span class="${p2>1.3?'green':p2<0.8?'red':''}">${p2}</span></td>
                        <td class="outcome-cell"><span data-outcome="1" class="cursor-pointer selected">1</span><span data-outcome="X" class="cursor-pointer selected">X</span><span data-outcome="2" class="cursor-pointer selected">2</span></td>
                        <td class="text-gray-400 font-medium">${i+1}</td>
                    </tr>`;
                });
                matchesTable.innerHTML = html + "</tbody></table>";
                matchesTable.querySelectorAll('.outcome-cell span').forEach(s => s.onclick = () => s.classList.toggle('selected'));
            }

            fetchBtn.onclick = async () => {
                const d = await fetchData(`https://api.www.svenskaspel.se/external/1/draw/${gameSelect.value}/draws?accesskey=4a735ed0-b0c8-4a9a-8ea9-35bfd8d23ea7`);
                const res = parseMatches(d);
                allMatches = res.matches;
                productNameSpan.textContent = "Product: " + res.name;
                closeTimeSpan.textContent = "Close Time: " + res.time;
                render(allMatches);
            };

            document.getElementById('calculateBtn').onclick = () => {
                currentFilteredSlips = [];
                const sels = Array.from(document.querySelectorAll('.outcome-cell')).map(c => Array.from(c.querySelectorAll('.selected')).map(s => s.dataset.outcome));
                let total = 1; sels.forEach(s => total *= s.length);
                document.getElementById('totalSlips').textContent = total;

                function gen(idx, curr) {
                    if (idx === 13) {
                        let f=0, u=0, x=0;
                        curr.forEach((v, i) => { if(v===allMatches[i].fav) f++; if(v===allMatches[i].und) u++; if(v==='X') x++; });
                        if (f>=document.getElementById('minFavs').value && f<=document.getElementById('maxFavs').value &&
                            u>=document.getElementById('minUnderdogs').value && u<=document.getElementById('maxUnderdogs').value &&
                            x>=document.getElementById('minDraws').value && x<=document.getElementById('maxDraws').value) {
                            currentFilteredSlips.push(curr.join(''));
                        }
                        return;
                    }
                    sels[idx].forEach(o => { curr.push(o); gen(idx+1, curr); curr.pop(); });
                }
                gen(0, []);
                document.getElementById('filteredSlips').textContent = currentFilteredSlips.length;
                document.getElementById('exportSlipsBtn').disabled = document.getElementById('exportAnalysisBtn').disabled = currentFilteredSlips.length === 0;
            };

            document.getElementById('exportSlipsBtn').onclick = () => {
                const pureName = productNameSpan.textContent.replace("Product: ", "");
                const now = new Date();
                const timestamp = now.toISOString().split('T')[0] + "_" + now.getHours().toString().padStart(2, '0') + "-" + now.getMinutes().toString().padStart(2, '0');
                const content = pureName + "\n" + currentFilteredSlips.map(s => "E," + s.split('').join(',')).join('\n');
                const blob = new Blob([content], {type: 'text/plain'});
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); a.download = `${pureName}_${timestamp}_slips.txt`; a.click();
            };

            document.getElementById('exportAnalysisBtn').onclick = () => {
                const pureName = productNameSpan.textContent.replace("Product: ", "");
                const now = new Date();
                const timestamp = now.toISOString().split('T')[0] + "_" + now.getHours().toString().padStart(2, '0') + "-" + now.getMinutes().toString().padStart(2, '0');
                let analysis = `Analysis - ${pureName}\nGenerated: ${now.toLocaleString('sv-SE')}\nFilters: Favs ${minFavs.value}-${maxFavs.value}, Und ${minUnderdogs.value}-${maxUnderdogs.value}, X ${minDraws.value}-${maxDraws.value}\n\n`;
                allMatches.forEach((m, i) => {
                    const outcomes = new Set(currentFilteredSlips.map(s => s[i]));
                    analysis += `${i+1}. ${m.home}-${m.away} | Outcomes in slips: ${Array.from(outcomes).sort().join(' ')}\n`;
                });
                const blob = new Blob([analysis], {type: 'text/plain'});
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); a.download = `${pureName}_${timestamp}_analysis.txt`; a.click();
            };

            document.getElementById('toggleAllBtn').onclick = () => {
                const spans = matchesTable.querySelectorAll('.outcome-cell span');
                const any = Array.from(spans).some(s => s.classList.contains('selected'));
                spans.forEach(s => any ? s.classList.remove('selected') : s.classList.add('selected'));
            };

            fetchBtn.click();
        });
    </script>
</body>
</html>
