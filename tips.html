<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipsXtra AI-Reducer - ivarsson.one</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-size: 0.70rem; text-transform: uppercase; color: #6b7280; }
        .outcome-cell span { 
            display: inline-block; width: 28px; height: 28px; line-height: 28px; 
            text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;
            margin-right: 2px; font-weight: bold; transition: all 0.1s; font-size: 0.8rem;
        }
        .outcome-cell span.selected { background-color: #2563eb; color: white; border-color: #2563eb; }
        .val-good { color: #059669; font-weight: bold; } 
        .val-bad { color: #dc2626; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">TipsXtra <span class="text-blue-600">AI</span></h1>
                <p class="text-gray-500" id="productName">V칛ntar p친 data...</p>
                <p class="text-xs text-gray-400" id="closeTime"></p>
            </div>
            <div class="flex gap-2">
                <select id="gameSelect" class="border rounded-lg px-3 py-2 bg-white shadow-sm">
                    <option value="stryktipset">Stryktipset</option>
                    <option value="europatipset">Europatipset</option>
                </select>
                <button id="fetchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">H칛mta</button>
            </div>
        </header>

        <div id="corsWarning" class="hidden mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded shadow-sm">
            <p class="font-bold">丘멆잺 Anslutningsproblem (CORS)</p>
            <p class="text-sm mt-1">
                Webbl칛saren blockerade anropet till Svenska Spel. Eftersom vi h칛mtar data direkt (som i din andra kod) 
                m친ste du ha ett till칛gg som "Allow CORS" aktiverat i din webbl칛sare, eller k칬ra detta i en milj칬 som till친ter det.
            </p>
        </div>

        <div id="ai-analysis" class="card mb-6 border-l-4 border-purple-500 hidden">
            <h2 class="text-lg font-bold mb-3 flex items-center">
                <span class="mr-2">游</span> AI-Optimering & Spelf칬rslag
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="ai-content">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-3 card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 text-sm uppercase">Matcher, Odds & V칛rde</h2>
                    <div class="flex gap-2">
                        <button id="markFavsBtn" class="text-[10px] bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded border border-blue-200 uppercase font-bold">Spika favoriter</button>
                        <button id="markAllBtn" class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded border border-gray-300 uppercase font-bold">Alla tecken (1X2)</button>
                        <button id="clearAllBtn" class="text-[10px] bg-red-50 hover:bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200 uppercase font-bold">Rensa</button>
                    </div>
                </div>
                <div id="matchesTable" class="overflow-x-auto"></div>
            </div>

            <div class="card space-y-6">
                <div>
                    <h2 class="font-bold mb-4 flex items-center text-xs uppercase text-gray-500">丘뙖잺 Filter</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold">Favoriter (Odds <2.1)</label>
                                <div class="flex gap-1">
                                    <input type="number" id="minFavs" class="save-state w-full border rounded p-1 text-xs" value="5">
                                    <input type="number" id="maxFavs" class="save-state w-full border rounded p-1 text-xs" value="9">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase text-gray-400 font-bold">Skr칛llar (<25%)</label>
                                <div class="flex gap-1">
                                    <input type="number" id="minUnder" class="save-state w-full border rounded p-1 text-xs" value="1">
                                    <input type="number" id="maxUnder" class="save-state w-full border rounded p-1 text-xs" value="4">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase text-gray-400 font-bold">Oavgjorda (X)</label>
                            <div class="flex gap-1">
                                <input type="number" id="minDraws" class="save-state w-full border rounded p-1 text-xs" value="2">
                                <input type="number" id="maxDraws" class="save-state w-full border rounded p-1 text-xs" value="6">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase text-gray-400 font-bold">Utdelning (kr)</label>
                            <div class="flex gap-2 items-center">
                                <input type="number" id="minPayout" class="save-state w-full border rounded p-1 text-xs" value="50000">
                                <input type="number" id="maxPayout" class="save-state w-full border rounded p-1 text-xs" value="2000000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t">
                    <button id="calculateBtn" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 shadow-lg transition-all active:scale-95 uppercase tracking-wider">
                        Ber칛kna Rader
                    </button>
                </div>

                <div id="resultsArea" class="hidden pt-4 border-t">
                    <div class="bg-blue-50 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between text-[10px]"><span class="text-gray-500 uppercase">Matematiska rader:</span> <span id="mathRader" class="font-bold text-gray-700">0</span></div>
                        <div class="flex justify-between text-[10px] items-center"><span class="text-gray-500 uppercase">Efter reducering:</span> <span id="filteredSlips" class="font-bold text-blue-700 text-xl">0</span></div>
                        <div class="flex justify-between text-[10px] pt-2 border-t border-blue-100"><span class="text-gray-500 uppercase">Snittutdelning:</span> <span id="avgOut" class="font-bold text-gray-800">0 kr</span></div>
                        <button id="exportSlipsBtn" class="w-full mt-4 bg-gray-800 text-white py-2 rounded-lg text-xs uppercase font-bold tracking-tight">Ladda ner .txt</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allMatches = [];
        let calculatedRader = [];
        
        // H칛r anv칛nder vi nyckeln och URL-strukturen fr친n KOD 2
        const API_KEY = "accesskey=4a735ed0-b0c8-4a9a-8ea9-35bfd8d23ea7";
        const API_BASE = "https://api.www.svenskaspel.se/external/1/draw/";

        window.onload = async () => { 
            loadSavedSettings(); 
            // Vid start f칬rs칬ker vi h칛mta det valda spelet direkt
            await fetchDirectData();
        };

        function loadSavedSettings() {
            document.querySelectorAll('.save-state').forEach(input => {
                const saved = localStorage.getItem(input.id);
                if (saved) input.value = saved;
                input.onchange = () => localStorage.setItem(input.id, input.value);
            });
        }

        // KOPPLAT FR칀N KOD 2: Direkt h칛mtning utan proxy
        async function fetchDirectData() {
            const game = document.getElementById('gameSelect').value;
            const url = `${API_BASE}${game}/draws?${API_KEY}`;
            const warning = document.getElementById('corsWarning');
            
            warning.classList.add('hidden'); // D칬lj varning f칬rst

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Vi skickar datat till parse-funktionen som anpassats f칬r Layout 1
                const parsedData = parseDataForLayout1(data);
                if(parsedData) updateUI(parsedData);
                
            } catch (e) {
                console.error("H칛mtningsfel:", e);
                // Visa varning om det misslyckas (troligen CORS)
                warning.classList.remove('hidden');
            }
        }

        // Denna funktion tar datat fr친n API:t (Kod 2 struktur) och formar om det till objektet som Layout 1 kr칛ver
        function parseDataForLayout1(data) {
            if (!data || !data.draws || data.draws.length === 0) return null;
            let draw = data.draws[0];
            
            return {
                name: draw.productName, 
                time: new Date(draw.closeTime).toLocaleString('sv-SE', {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'}),
                rawTime: draw.closeTime,
                matches: draw.events.map(e => {
                    // Parsa odds och f칬rdelning (fr친n Kod 2 logik men sparat i Kod 1 format)
                    const g = (v) => v ? parseFloat(v.toString().replace(',','.')) : 0;
                    const odds = { '1': g(e.odds?.home), 'X': g(e.odds?.draw), '2': g(e.odds?.away) };
                    const dist = { '1': e.distribution.home/100, 'X': e.distribution.draw/100, '2': e.distribution.away/100 };
            
                    // Ber칛kna v칛rde
                    const calcVal = (o, d) => (o > 0 && d > 0) ? ((1 / o) / d).toFixed(2) : "0.00";
                    const val = { 
                        '1': calcVal(odds['1'], dist['1']), 
                        'X': calcVal(odds['X'], dist['X']), 
                        '2': calcVal(odds['2'], dist['2']) 
                    };

                    // VIKTIGT: F칬r att AI-funktionen ska fungera m친ste vi veta vem som 칛r favorit
                    // Detta fanns i Kod 1 men saknades i Kod 2. Vi 친terskapar det h칛r.
                    const fav = Object.entries(odds).sort((a,b) => {
                        // Sortera l칛gst odds f칬rst. Om odds 칛r 0 l칛ggs det sist.
                        if(a[1] === 0) return 1;
                        if(b[1] === 0) return -1;
                        return a[1] - b[1];
                    })[0][0];

                    return { 
                        home: e.participants[0].name, 
                        away: e.participants[1].name, 
                        odds: { '1': odds['1'].toFixed(2), 'X': odds['X'].toFixed(2), '2': odds['2'].toFixed(2) }, 
                        dist, 
                        val, 
                        fav: fav 
                    };
                })
            };
        }

        function updateUI(res) {
            if (!res || !res.matches) return;
            allMatches = res.matches;
            document.getElementById('productName').textContent = res.name;
            document.getElementById('closeTime').textContent = "Spelstopp: " + res.time;
            renderTable();
            runAIAnalysis();
        }

        // --- H츿R B칐RJAR LAYOUT-LOGIKEN FR칀N KOD 1 (Of칬r칛ndrad) ---

        function renderTable() {
            let html = `<table><thead><tr><th class="w-8">#</th><th>Match</th><th>Folk %</th><th>Odds</th><th>V칛rde</th><th>Val</th><th class="w-8">#</th></tr></thead><tbody>`;
            allMatches.forEach((m, i) => {
                const getValClass = (v) => v > 1.10 ? 'val-good' : (v < 0.85 ? 'val-bad' : '');
                html += `<tr>
                    <td class="text-xs text-gray-400 font-bold">${i+1}</td>
                    <td class="text-sm font-bold">${m.home} - ${m.away}</td>
                    <td class="text-[10px] text-blue-600 font-mono">${Math.round(m.dist['1']*100)}%|${Math.round(m.dist['X']*100)}%|${Math.round(m.dist['2']*100)}%</td>
                    <td class="text-[10px] text-gray-500 font-mono">${m.odds['1']}|${m.odds['X']}|${m.odds['2']}</td>
                    <td class="text-[10px] font-mono"><span class="${getValClass(m.val['1'])}">${m.val['1']}</span>|<span class="${getValClass(m.val['X'])}">${m.val['X']}</span>|<span class="${getValClass(m.val['2'])}">${m.val['2']}</span></td>
                    <td class="outcome-cell" data-row="${i}"><span data-o="1">1</span><span data-o="X">X</span><span data-o="2">2</span></td>
                    <td class="text-xs text-gray-400 font-bold">${i+1}</td>
                </tr>`;
            });
            document.getElementById('matchesTable').innerHTML = html + "</tbody></table>";
            document.querySelectorAll('.outcome-cell span').forEach(s => s.onclick = () => s.classList.toggle('selected'));
        }

        function runAIAnalysis() {
            const aiContent = document.getElementById('ai-content');
            document.getElementById('ai-analysis').classList.remove('hidden');
            let spikar = [], skrallar = [], varningar = [];

            allMatches.forEach((m, i) => {
                const oddValue = parseFloat(m.odds[m.fav]);
                const prob = oddValue > 0 ? (1 / oddValue) : 0;
                const diff = (m.dist[m.fav] - prob) * 100;
                
                // AI Logik
                if (prob > 0.50 && diff < 7) spikar.push(`M${i+1}: ${m.fav==='1'?m.home:m.away} (${Math.round(m.dist[m.fav]*100)}%)`);
                
                ['1','X','2'].forEach(o => {
                    const value = parseFloat(m.val[o]);
                    if (value > 1.05 && o !== m.fav) {
                        const name = o === '1' ? m.home : (o === 'X' ? 'Krysset' : m.away);
                        skrallar.push({text: `M${i+1}: ${name} (V칛rde ${value})`, val: value});
                    }
                });
                
                if (diff > 10) varningar.push(`M${i+1}: ${m.fav==='1'?m.home:m.away} (+${Math.round(diff)}%)`);
            });
            
            skrallar.sort((a, b) => b.val - a.val);
            
            aiContent.innerHTML = `
                <div class="p-3 bg-green-50 rounded border border-green-200"><h3 class="font-bold text-green-800 text-[10px] uppercase mb-2">游눑 B칛sta Spikarna</h3><ul class="text-[10px] space-y-1">${spikar.length?spikar.slice(0,4).map(s=>`<li>${s}</li>`).join(''):'Inga tydliga'}</ul></div>
                <div class="p-3 bg-yellow-50 rounded border border-yellow-200"><h3 class="font-bold text-yellow-800 text-[10px] uppercase mb-2">游댠 Drag & Skr칛llar</h3><ul class="text-[10px] space-y-1">${skrallar.length?skrallar.slice(0,5).map(s=>`<li>${s.text}</li>`).join(''):'Inga drag funna'}</ul></div>
                <div class="p-3 bg-red-50 rounded border border-red-200"><h3 class="font-bold text-red-800 text-[10px] uppercase mb-2">丘멆잺 Varning (칐verstreckat)</h3><ul class="text-[10px] space-y-1">${varningar.length?varningar.slice(0,4).map(v=>`<li>${v}</li>`).join(''):'Inga varningar'}</ul></div>
            `;
        }

        // Koppla knappen till den nya fetch-funktionen
        document.getElementById('fetchBtn').onclick = fetchDirectData;

        // Logic f칬r knappar och ber칛kning (samma som Kod 1)
        document.getElementById('markFavsBtn').onclick = () => {
            allMatches.forEach((m, i) => {
                document.querySelectorAll(`.outcome-cell[data-row="${i}"] span`).forEach(s => s.classList.remove('selected'));
                document.querySelector(`.outcome-cell[data-row="${i}"] span[data-o="${m.fav}"]`).classList.add('selected');
            });
        };
        document.getElementById('markAllBtn').onclick = () => document.querySelectorAll('.outcome-cell span').forEach(s => s.classList.add('selected'));
        document.getElementById('clearAllBtn').onclick = () => document.querySelectorAll('.outcome-cell span').forEach(s => s.classList.remove('selected'));
        
        document.getElementById('calculateBtn').onclick = () => {
            const selections = Array.from(document.querySelectorAll('.outcome-cell')).map(c => Array.from(c.querySelectorAll('.selected')).map(s => s.dataset.o));
            if (selections.some(s => s.length === 0)) return alert("V칛lj minst ett tecken per match!");
            
            const mathCount = selections.reduce((a, b) => a * b.length, 1);
            if(mathCount > 100000) if(!confirm(`Detta skapar ${mathCount} rader. Forts칛tta?`)) return;
            
            const conf = {
                minF: parseInt(document.getElementById('minFavs').value), maxF: parseInt(document.getElementById('maxFavs').value),
                minU: parseInt(document.getElementById('minUnder').value), maxU: parseInt(document.getElementById('maxUnder').value),
                minX: parseInt(document.getElementById('minDraws').value), maxX: parseInt(document.getElementById('maxDraws').value),
                minP: parseInt(document.getElementById('minPayout').value), maxP: parseInt(document.getElementById('maxPayout').value)
            };
            
            calculatedRader = [];
            let payouts = [];
            
            function gen(idx, rad, prob) {
                if (idx === 13) {
                    let f=0, u=0, x=0;
                    rad.forEach((o, i) => { 
                        // H칛r kollar vi oddset direkt fr친n datan
                        const odd = parseFloat(allMatches[i].odds[o]);
                        if(odd <= 2.1 && odd > 0) f++; 
                        if(allMatches[i].dist[o] < 0.25) u++;
                        if(o === 'X') x++;
                    });
                    
                    let payout = prob > 0 ? (1 / prob) * 0.65 : 0;
                    
                    if (f>=conf.minF && f<=conf.maxF && u>=conf.minU && u<=conf.maxU && x>=conf.minX && x<=conf.maxX && payout>=conf.minP && payout<=conf.maxP) {
                        calculatedRader.push(rad.join('')); payouts.push(payout);
                    }
                    return;
                }
                for (let o of selections[idx]) gen(idx + 1, [...rad, o], prob * allMatches[idx].dist[o]);
            }
            
            gen(0, [], 1.0);
            
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('mathRader').textContent = mathCount.toLocaleString();
            document.getElementById('filteredSlips').textContent = calculatedRader.length.toLocaleString();
            document.getElementById('avgOut').textContent = Math.round(payouts.reduce((a,b)=>a+b,0)/(payouts.length||1)).toLocaleString() + " kr";
        };
        
       document.getElementById('exportSlipsBtn').onclick = () => {
            if (calculatedRader.length === 0) return alert("Inga rader att exportera!");

            // H칛mta speltyp (t.ex. "Stryktipset")
            const gameType = document.getElementById('productName').textContent.trim();
            
            // Skapa tidsst칛mpel f칬r filnamnet (YYYY-MM-DD_HH-MM)
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.getHours().toString().padStart(2, '0') + "-" + now.getMinutes().toString().padStart(2, '0');
            
            // Generera filinneh친ll: F칬rsta raden 칛r speltyp, sedan E-rader
            const fileContent = gameType + "\nE," + calculatedRader.map(r => r.split('').join(',')).join('\nE,');
            
            const blob = new Blob([fileContent], {type: 'text/plain'});
            const a = document.createElement('a');
            
            // Filnamn: t.ex. Stryktipset_2026-02-11_17-30.txt
            a.download = `${gameType}_${dateStr}_${timeStr}.txt`;
            a.href = URL.createObjectURL(blob);
            a.click();
            
            // St칛da upp URL-objektet
            setTimeout(() => URL.revokeObjectURL(a.href), 100);
        };
    </script>
</body>
</html>
